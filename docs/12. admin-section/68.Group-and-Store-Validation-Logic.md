[< Volver al índice](../index.md)

# Group and Store Validation Logic

Este episodio se enfoca en mejorar el AdminPostController al abordar la duplicación de reglas de validación en las acciones store y update. El objetivo principal es refactorizar el código para que sea más limpio y mantenible sin introducir complejidad innecesaria.

1. Identificar la Duplicación

Las acciones store y update tenían reglas de validación similares con diferencias menores. Para abordar esto, identificamos la duplicación y planificamos consolidar las reglas comunes.

2. Consolidar Reglas de Validación
Creamos un método validatePost para manejar la lógica de validación común. Este método puede ser llamado con o sin una instancia de post existente, haciéndolo versátil para la creación y actualización de publicaciones.

```php
protected function validatePost(?Post $post = null): array
    {
        $post ??= new Post();

        return request()->validate([
            'title' => 'required',
            'thumbnail' => $post->exists ? ['image'] : ['required', 'image'],
            'slug' => ['required', Rule::unique('posts', 'slug')->ignore($post)],
            'excerpt' => 'required',
            'body' => 'required',
            'category_id' => ['required', Rule::exists('categories', 'id')],
            'published_at' => 'required'
        ]);
    }
```

3. Refactorizar las Acciones `store` y `update`
Con el método validatePost en su lugar, simplificamos las acciones store y update llamando a este método con los parámetros apropiados.

```php
public function store()
{
    Post::create(array_merge($this->validatePost(), [
        'user_id' => request()->user()->id,
        'thumbnail' => request()->file('thumbnail')->store('thumbnails')
    ]));

    return redirect('/');
}

public function update(Post $post)
    {
        $attributes = $this->validatePost($post);

        if ($attributes['thumbnail'] ?? false) {
            $attributes['thumbnail'] = request()->file('thumbnail')->store('thumbnails');
        }

        $post->update($attributes);

        return back()->with('success', 'Post Updated!');
    }
```

En la acción store, pasamos una nueva instancia de Post al método validatePost, mientras que en la acción update, pasamos la instancia existente del Post. Esto asegura que las reglas de validación se ajusten según el contexto.
