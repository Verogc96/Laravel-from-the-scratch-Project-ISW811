[< Volver al Ã­ndice](../index.md)

# Extract a Newsletter Service

En este episodio se extrae el servicio de Newsletter en una clase php. Para ello se realiza lo siguiente:

- #### Crear un folder dentro de *app* llamado *Services* y agregamos un archivo de clase php llamado Newsletter.php y le agregamos el siguiente codigo

```php
<?php

namespace App\Services;

use MailchimpMarketing\ApiClient;

class Newsletter
{
    public function subscribe(string $email, string $list = null)
    {
        $list ??= config('services.mailchimp.lists.subscribers');

        return $this->client()->lists->addListMember($list, [
            'email_address' => $email,
            'status' => 'subscribed'
        ]);
    }

    protected function client()
    {
        return (new ApiClient())->setConfig([
            'apiKey' => config('services.mailchimp.key'),
            'server' => 'us13'
        ]);
    }
}
```

- #### Creamos un nuevo controller llamado *NewsletterController.php* con el comando `php artisan make:controller NewsletterController` y agregamos el siguiente codigo:

```php
 public function __invoke(Newsletter $newsletter)
{
    request()->validate(['email' => 'required|email']);

    try {
        $newsletter->subscribe(request('email'));
    } catch (Exception $e) {
        throw ValidationException::withMessages([
            'email' => 'This email could not be added to our newsletter list.'
        ]);
    }

    return redirect('/')
        ->with('success', 'You are now signed up for our newsletter!');
}
```

- #### Quitamos la ruta de newsletter creada anteriormente y la sustituimos por esta linea de codigo:

```php
Route::post('newsletter', NewsletterController::class);
```

- #### Agregamos una nueva variable de entorno en el archivo .env con los datos de la lista de mailchimp:

```
MAILCHIMP_LIST_SUBSCRIBERS="6d4b7954ba"
```

- #### Agregamos la lista de suscripciones dentro de *services.php*, quedando el codigo de la siguiente manera:

```php
'mailchimp' => [
        'key' => env('MAILCHIMP_KEY'),
        'lists' => [
            'subscribers' => env('MAILCHIMP_LIST_SUBSCRIBERS')
        ]
    ]
```
