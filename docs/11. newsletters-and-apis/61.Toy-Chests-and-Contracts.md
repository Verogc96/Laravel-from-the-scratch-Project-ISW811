[< Volver al índice](../index.md)

# Toy Chests and Contracts

En este episodio se muestra el uso de contenedores de servicios en Laravel, incluyendo la resolución automática de dependencias y la inyección de dependencias en controladores.

## Contenedores de Servicios en Laravel

Un contenedor de servicios en Laravel es una herramienta poderosa que administra dependencias y realiza la inyección de dependencias. Permite registrar servicios y resolver dependencias de manera automática.

## Resolución Automática

La resolución automática permite que Laravel instancie clases sin necesidad de definir explícitamente cada dependencia. Por ejemplo, al solicitar una instancia de Newsletter en un controlador, Laravel revisa el contenedor de servicios (un "toy chest") para encontrar la instancia correspondiente.

### Para ello se realiza se cambia el parametro de la funcion *invoke*

```php
 public function __invoke(Newsletter $newsletter)
    {
        request()->validate(['email' => 'required|email']);

        try {
            $newsletter->subscribe(request('email'));
        } catch (Exception $e) {
            throw ValidationException::withMessages([
                'email' => 'This email could not be added to our newsletter list.'
            ]);
        }

        return redirect('/')
            ->with('success', 'You are now signed up for our newsletter!');
    }
```

### Le cambiamos el nombre del Servicio de Newsletter a *MailchimpNewsletter.php* y modificamos el codigo que quede de la siguiente manera:

```php
class MailchimpNewsletter implements Newsletter
{
    public function __construct(protected ApiClient $client)
    {
        //
    }

    public function subscribe(string $email, string $list = null)
    {
        $list ??= config('services.mailchimp.lists.subscribers');

        return $this->client->lists->addListMember($list, [
            'email_address' => $email,
            'status' => 'subscribed'
        ]);
    }
}
```

### Luego creamos una interfaz llamada *Newsletter.php* dentro de *App/Services* con el siguiente codigo

```php
<?php

namespace App\Services;

interface Newsletter
{
    public function subscribe(string $email, string $list = null);
}
```

### Y en *AppServiceProvider.php* ubicado en la ruta *app/Providers* modificamos el siguiente codigo:

```php
public function register()
{
    app()->bind(Newsletter::class, function () {
        $client = (new ApiClient)->setConfig([
            'apiKey' => config('services.mailchimp.key'),
            'server' => 'us13'
        ]);

        return new MailchimpNewsletter($client);
    });
    }
```

#### Estos cambios no deberian de afectar el funcionamiento de nuestra aplicacion.
